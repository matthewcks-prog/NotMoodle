{% load static dict_extras %}
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ lesson.title }} &bull; NotMoodle</title>
  <link rel="stylesheet" href="{% static 'css/student-style.css' %}">
  <link rel="stylesheet" href="{% static 'css/student-dashboard.css' %}">
  <style>
    .lesson-detail {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    .lesson-header {
      background: rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 12px 30px rgba(0,0,0,.15);
    }
    .lesson-title {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
      color: var(--muted);
    }
    .lesson-code {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    .lesson-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .meta-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
    }
    .meta-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    .meta-value {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .lesson-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }
    .main-content {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 30px rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,0.4);
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .sidebar-card {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 12px 30px rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,0.4);
    }
    .video-container {
      position: relative;
      width: 100%;
      height: 400px;
      margin-bottom: 20px;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #ddd;
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
    }
    .video-thumbnail-container {
      position: relative;
      width: 100%;
      height: 100%;
      cursor: pointer;
      overflow: hidden;
      border-radius: 10px;
    }
    .video-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      transition: transform 0.3s ease, filter 0.3s ease;
    }
    .video-thumbnail-container:hover .video-thumbnail {
      transform: scale(1.05);
      filter: brightness(0.8);
    }
    .play-button-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }
    .play-button {
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease, background 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .video-thumbnail-container:hover .play-button {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 1);
    }
    .video-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 10px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: #333;
    }
    .description, .objectives {
      line-height: 1.6;
      color: #666;
      margin-bottom: 20px;
    }
    .reading-list {
      list-style: none;
      padding: 0;
    }
    .reading-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .reading-item:last-child {
      border-bottom: none;
    }
    .reading-title {
      font-weight: 600;
      color: #333;
    }
    .reading-description {
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }
    .reading-url {
      color: #667eea;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .reading-url:hover {
      text-decoration: underline;
    }
    .prerequisite {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #28a745;
    }
    .prerequisite.missing {
      border-left-color: #dc3545;
      background: #fff5f5;
    }
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #667eea;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 20px;
      transition: background 0.3s ease;
    }
    .back-button:hover {
      background: #5a6fd8;
      text-decoration: none;
    }
    .enroll-button {
      background: #28a745;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    .enroll-button:hover {
      background: #218838;
      text-decoration: none;
    }
    .enroll-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .assignments-card{
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      margin-top:30px;
      padding:30px;
      border-radius:15px;
      box-shadow: 0 12px 30px rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,0.4);
    }
    .assignment-row{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      gap:20px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:20px 24px;
      margin-bottom:20px;
      background:linear-gradient(180deg,#fff 0%,#fafafa 100%);
      box-shadow:0 4px 12px rgba(0,0,0,.04)
    }
    .assignment-title{
      font-size:1.15rem;
      font-weight:700;
      color:#1f2937;margin:0
    }
    .assignment-meta{
      margin-top:6px;
      font-size:.9rem;
      color:#374151
    }
    .assignment-desc{
      margin-top:8px;
      color:#4b5563;
      line-height:1.55
    }
    .assignment-status{
      margin-top:8px;
      font-size:.9rem
    }
    .assignment-status.ok{
      color:#065f46
    }
    .assignment-status.muted{
      color:#6b7280
    }
    .assignment-actions{
      display:flex;
      align-items:center;
      gap:12px
    }
    .assignment-actions input[type="file"]{
      border:1px solid #d1d5db;
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      width:260px
    }
    .assignment-actions button{
      background:#4f46e5;
      color:#fff;padding:10px 22px;
      border:none;
      border-radius:10px;
      font-weight:600
    }
    .assignment-actions button:disabled{
      background:#a3a3a3;
      cursor:not-allowed
    }

    @media (max-width: 768px) {
      .lesson-content {
        grid-template-columns: 1fr;
      }
      .lesson-title {
        font-size: 2rem;
      }
      .lesson-meta {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <img class="blurred-background" src="{% static 'img/dashboard_background.jpg' %}" alt="">
  <div class="lesson-detail">
  <a href="{% url 'student_management:student_dashboard' %}" class="back-button">&larr; Back to Dashboard</a>

    <div class="lesson-header">
      <h1 class="lesson-title">{{ lesson.title }}</h1>
      <div class="lesson-code">{{ lesson.unit_code }}</div>

      <div class="lesson-meta">
        <div class="meta-item"><div class="meta-label">Estimated Effort</div><div class="meta-value">{{ lesson.estimated_effort }} hours/week</div></div>
        <div class="meta-item"><div class="meta-label">Credits</div><div class="meta-value">{{ lesson.lesson_credits }}</div></div>
        <div class="meta-item">
          <div class="meta-label">Lesson Designer</div>
          <div class="meta-value">
            {% if lesson.lesson_designer and lesson.lesson_designer.user %}
              {{ lesson.lesson_designer.user.get_full_name|default:lesson.lesson_designer.user.username }}
            {% else %}
              {{ lesson.lesson_designer }}
            {% endif %}
          </div>
        </div>
        <div class="meta-item"><div class="meta-label">Created</div><div class="meta-value">{{ lesson.date_of_creation|date:"M d, Y" }}</div></div>
        <div class="meta-item"><div class="meta-label">Last Updated</div><div class="meta-value">{{ lesson.date_of_update|date:"M d, Y" }}</div></div>
      </div>

      {% if has_grades %}
      <div style="margin-top: 20px; padding: 15px; background: {% if passed %}#dcfce7{% else %}#fef9c3{% endif %}; border-radius: 10px; border: 2px solid {% if passed %}#86efac{% else %}#fde047{% endif %};">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <div style="font-size: 14px; color: #6b7280; font-weight: 500;">Overall Mark</div>
            <div style="font-size: 28px; font-weight: 700; color: {% if passed %}#166534{% else %}#854d0e{% endif %}; margin-top: 4px;">{{ overall_percentage }}%</div>
          </div>
          <div style="padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 14px; background: {% if passed %}#22c55e{% else %}#eab308{% endif %}; color: white;">
            {% if passed %}‚úì PASSED{% else %}NOT PASSED{% endif %}
          </div>
        </div>
        {% if passed %}
        <div style="margin-top: 10px; font-size: 13px; color: #166534; font-weight: 500;">
          üéì Credits Earned: {{ lesson.lesson_credits }}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <div class="lesson-content">
      <div class="main-content">
        {% if lesson.youtube_link %}
          <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:12px;">
            <h2 class="section-title" style="margin:0;">Video Content</h2>
            {% if is_enrolled %}
            <form method="post" action="{% url 'lessons:toggle_video' lesson.id %}">
              {% csrf_token %}
              <label style="display:flex; align-items:center; gap:6px; cursor:pointer; background:#eef2ff; color:#333; padding:6px 10px; border-radius:8px;">
                <input type="checkbox" onchange="this.form.submit()" {% if video_watched %}checked{% endif %} />
                <span>{% if video_watched %}Marked as done{% else %}Mark as done{% endif %}</span>
              </label>
            </form>
            {% endif %}
          </div>

          <div class="video-container">
            {% if lesson.get_youtube_video_id %}
              {% if lesson.get_youtube_thumbnail %}
                <div class="video-thumbnail-container" onclick="loadVideo(this)">
                  <img src="{{ lesson.get_youtube_thumbnail }}" alt="{{ lesson.title }} thumbnail" class="video-thumbnail"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div class="play-button-overlay" style="display:none;">
                    <div class="play-button">
                      <svg width="68" height="48" viewBox="0 0 68 48">
                        <path d="M66.52,7.74...z" fill="#f00"></path>
                        <path d="M45,24 27,14 27,34" fill="#fff"></path>
                      </svg>
                    </div>
                  </div>
                  <div class="video-loading" style="display:none;">
                    <div class="loading-spinner"></div>
                    <p>Loading video...</p>
                  </div>
                </div>
                <iframe id="video-iframe-{{ lesson.id }}" src="" title="{{ lesson.title }}" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen playsinline
                        style="display:none;"></iframe>
              {% else %}
                <iframe src="{{ lesson.get_youtube_embed_url }}?playsinline=1&modestbranding=1&rel=0"
                        title="{{ lesson.title }}" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen playsinline></iframe>
              {% endif %}
            {% else %}
              <div style="display:flex; align-items:center; justify-content:center; height:100%; background:#f8f9fa; color:#666;">
                <div style="text-align:center;">
                  <p>Video not available</p>
                  <small>Invalid or missing YouTube link</small>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {% if lesson.description %}
          <h2 class="section-title">Description</h2>
          <div class="description">{{ lesson.description|linebreaks }}</div>
        {% endif %}

        {% if lesson.objectives %}
          <h2 class="section-title">Learning Objectives</h2>
          <div class="objectives">{{ lesson.objectives|linebreaks }}</div>
        {% endif %}
      </div>

      <div class="sidebar">
        {% if not is_enrolled and missing_prerequisites %}
          <div class="sidebar-card">
            <h3 class="section-title">Prerequisites Required</h3>
            <p style="color:#dc3545;">You must pass these lessons first:</p>
            {% for prereq in missing_prerequisites %}
              <div class="prerequisite missing">
                <div class="prerequisite-title">{{ prereq.title }}</div>
                <div class="prerequisite-code">{{ prereq.unit_code }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% if prerequisites %}
          <div class="sidebar-card">
            <h3 class="section-title">Prerequisites</h3>
            {% for prereq in completed_prerequisites %}
              <div class="prerequisite">
                <div class="prerequisite-title">‚úì {{ prereq.title }}</div>
                <div class="prerequisite-code">{{ prereq.unit_code }} (Passed)</div>
              </div>
            {% endfor %}
            {% for prereq in missing_prerequisites %}
              <div class="prerequisite missing">
                <div class="prerequisite-title">‚úó {{ prereq.title }}</div>
                <div class="prerequisite-code">{{ prereq.unit_code }} (Not Passed)</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% if reading_list %}
          <div class="sidebar-card">
            <h3 class="section-title">Reading List</h3>
            <ul class="reading-list">
              {% for reading in reading_list %}
                <li class="reading-item">
                  <div class="reading-title">{{ reading.title }}</div>
                  {% if reading.description %}<div class="reading-description">{{ reading.description }}</div>{% endif %}
                  {% if reading.url %}<a href="{{ reading.url }}" target="_blank" class="reading-url">View Resource &rarr;</a>{% endif %}
                  {% if is_enrolled %}
                  <form method="post" action="{% url 'lessons:toggle_reading' lesson.id reading.id %}" style="margin-top:8px;">
                    {% csrf_token %}
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                      <input type="checkbox" onchange="this.form.submit()" {% if reading.id in completed_reading_ids %}checked{% endif %} />
                      <span>{% if reading.id in completed_reading_ids %}Marked as done{% else %}Mark as done{% endif %}</span>
                    </label>
                  </form>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if not is_enrolled %}
          <div class="sidebar-card">
            {% if missing_prerequisites %}
              <button class="enroll-button" disabled>Pass Prerequisites First</button>
            {% else %}
              <a href="{% url 'lessons:enroll' lesson.id %}" class="enroll-button">Enroll in Lesson</a>
            {% endif %}
          </div>
        {% else %}
          <div class="sidebar-card">
            <div style="text-align:center; padding:20px; background:#d4edda; border-radius:10px; color:#155724;">
              <strong>&#10003; Enrolled</strong><br>
              <small>You are currently enrolled in this lesson</small>
            </div>
          </div>
        {% endif %}

        <div class="sidebar-card">
          {% if classroom_enrol %}
            <div style="text-align:center;padding:20px;background:#d4edda;border-radius:10px;color:#155724;margin-bottom:12px">
              <strong>&#10003; Enrolled</strong><br>
              <small>You are currently enrolled in a classroom for this lesson.</small>
            </div>
            <h3 class="section-title">Classroom Info</h3>
            <p><strong>Course:</strong> {{ classroom_enrol.course }}</p>
            <p><strong>Teacher:</strong>
              {% if classroom_enrol.teacher.user %}
                {{ classroom_enrol.teacher.user.get_full_name|default:classroom_enrol.teacher.user.username }}
              {% else %}
                {{ classroom_enrol.teacher }}
              {% endif %}
            </p>
            <p><strong>Start:</strong> {{ classroom_enrol.start_date|date:"M d, Y H:i" }}</p>
            <p><strong>End:</strong> {{ classroom_enrol.end_date|date:"M d, Y H:i" }}</p>
          {% else %}
            <div style="text-align:center;padding:20px;background:#f8f9fa;border-radius:10px;color:#6c757d">
              <strong>Not enrolled</strong><br>
              <small>You are not enrolled in any classroom for this lesson.</small>
            </div>
          {% endif %}
        </div>
      </div>
    </div> <!-- end lesson-content -->

    {% if assignments %}
      {% if classroom_enrol %}
        <!-- Full-width assignments box -->
        <div class="assignments-card">
          <h2 class="section-title" style="margin-bottom:20px">Assignments</h2>

          {% for a in assignments %}
            <div class="assignment-row">
              <div>
                <h3 class="assignment-title">{{ a.title }}</h3>

                <div class="assignment-meta">
                  {% if a.due_date %}<strong>Due:</strong> {{ a.due_date|date:"M d, Y H:i" }}
                  {% elif a.deadline %}<strong>Due:</strong> {{ a.deadline|date:"M d, Y H:i" }}
                  {% elif a.submission_deadline %}<strong>Due:</strong> {{ a.submission_deadline|date:"M d, Y H:i" }}{% endif %}
                  {% if a.max_marks %}&nbsp;&bull;&nbsp;<strong>Max:</strong> {{ a.max_marks }}
                  {% elif a.total_marks %}&nbsp;&bull;&nbsp;<strong>Max:</strong> {{ a.total_marks }}
                  {% elif a.marks %}&nbsp;&bull;&nbsp;<strong>Max:</strong> {{ a.marks }}{% endif %}
                  {% if a.weightage %}&nbsp;&bull;&nbsp;<strong>Weightage:</strong> {{ a.weightage }}%{% endif %}
                </div>

                {% if a.description %}
                  <div class="assignment-desc">{{ a.description|linebreaksbr }}</div>
                {% endif %}

                <!-- TEACHER FILES (attachments) -->
                <div style="margin-top:8px;font-size:.92rem;">
                  <strong>Files:</strong>
                  {% with atts=a.attachments.all %}
                    {% if a.pdf or atts %}
                      <ul class="attachments" style="margin:.35rem 0 0; padding-left:1.1rem;">
                        {% if a.pdf %}
                          <li>
                            <a href="{% url 'lessons:assignment_download' a.pk %}" target="_blank" rel="noopener">üìÑ {{ a.pdf_filename }}</a>
                          </li>
                        {% endif %}
                        {% for att in atts %}
                          <li>
                            <a href="{{ att.file.url }}" target="_blank" rel="noopener">üìÑ {{ att.filename }}</a>
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <span style="color:#6b7280">No files uploaded.</span>
                    {% endif %}
                  {% endwith %}
                </div>

                <!-- STUDENT SUBMISSION (if any) -->
                {% with sub=submission_map|get_item:a.id grade=grade_map|get_item:a.id %}
                  <div class="assignment-status" style="margin-top:6px;">
                    <strong>Your submission:</strong>
                    {% if sub %}
                      <span class="ok">
                        {{ sub.submitted_at|date:"M d, Y H:i" }} -
                        <a href="{{ sub.pdf.url }}" target="_blank" rel="noopener">View PDF</a>
                      </span>
                    {% else %}
                      <span class="muted">No submission yet.</span>
                    {% endif %}
                  </div>

                  {% if grade %}
                    <div class="assignment-status" style="margin-top:6px; color:#2563eb;">
                      <strong>Grade:</strong> 
                      {% if grade.marks_awarded is not None %}
                        {{ grade.marks_awarded }} / {{ a.marks }}
                      {% else %}
                        <span style="color:#6b7280;">Not graded</span>
                      {% endif %}
                      {% if grade.feedback %}<br><strong>Feedback:</strong> {{ grade.feedback }}{% endif %}
                    </div>
                  {% endif %}

                  {% if not sub %}
                    <form class="assignment-actions"
                          method="post"
                          action="{% url 'lessons:submit_assignment' lesson.id a.id %}"
                          enctype="multipart/form-data">
                      {% csrf_token %}
                      <input type="file" name="pdf" accept="application/pdf"
                            {% if not is_enrolled %}disabled{% endif %} required />
                      <button type="submit" {% if not is_enrolled %}disabled{% endif %}>Submit</button>
                    </form>
                  {% endif %}

                  {% if is_teacher and sub %}
                    <form class="assignment-actions" method="post" action="" style="margin-top:10px;">
                      {% csrf_token %}
                      <input type="hidden" name="grade_assignment_id" value="{{ a.id }}" />
                      <label>Grade:
                        <input type="number" name="marks_awarded" min="0" max="{{ a.marks }}" step="0.01" value="{% if grade %}{{ grade.marks_awarded }}{% endif %}" required />
                      </label>
                      <label>Feedback:
                        <input type="text" name="feedback" value="{% if grade %}{{ grade.feedback }}{% endif %}" />
                      </label>
                      <button type="submit">Save Grade</button>
                    </form>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <!-- Message when not rostered by a teacher -->
        <div class="assignments-card">
          <h2 class="section-title" style="margin-bottom:12px">Assignments</h2>
          <div style="padding:14px 16px; background:#fff7ed; border:1px solid #fdba74; color:#7c2d12; border-radius:12px; font-weight:600;">
            <strong>‚ö†Ô∏è Classroom Enrollment Required</strong><br>
            <small style="font-weight:400; margin-top:4px; display:block;">Your teacher needs to enroll you in a classroom for this lesson before you can access assignments, submit work, and receive grades.</small>
          </div>
        </div>
      {% endif %}
    {% else %}
      <!-- No assignments in this lesson yet -->
      {% if classroom_enrol %}
        <div class="assignments-card">
          <h2 class="section-title" style="margin-bottom:12px">Assignments</h2>
          <div style="padding:14px 16px; background:#e0e7ff; border:1px solid #a5b4fc; color:#3730a3; border-radius:12px; font-weight:600;">
            <strong>‚ÑπÔ∏è No Assignments Yet</strong><br>
            <small style="font-weight:400; margin-top:4px; display:block;">Your teacher hasn't added any assignments to this lesson yet. Check back later!</small>
          </div>
        </div>
      {% endif %}
    {% endif %}

  </div>

  <script>
    function loadVideo(thumbnailContainer) {
      const loadingDiv = thumbnailContainer.querySelector('.video-loading');
      const iframe = thumbnailContainer.parentElement.querySelector('iframe');
      if (loadingDiv && iframe) {
        thumbnailContainer.style.display = 'none';
        loadingDiv.style.display = 'flex';
        let base = "{{ lesson.get_youtube_embed_url|safe }}".replace('https://www.youtube.com/embed', 'https://www.youtube-nocookie.com/embed');
        const origin = encodeURIComponent(window.location.origin);
        iframe.src = base + "?enablejsapi=1&playsinline=1&modestbranding=1&rel=0&autoplay=1&origin=" + origin;
        iframe.onload = () => { loadingDiv.style.display = 'none'; iframe.style.display = 'block'; };
        setTimeout(() => {
          if (loadingDiv.style.display !== 'none') {
            loadingDiv.style.display = 'none';
            iframe.style.display = 'block';
          }
        }, 3000);
      }
    }
  </script>
</body>
</html>