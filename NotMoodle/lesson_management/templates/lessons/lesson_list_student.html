{% load static %}
{% load dict_extras %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Available Lessons</title>
    <style>
      :root { --bg-blur: 4px; --accent:#2d6cdf; }
      html, body { height:100%; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      .bg { position:fixed; inset:0; background:url('{% static "img/dashboard_background.jpg" %}') center/cover no-repeat; filter: blur(12px); transform: scale(1.05); z-index:-1; }
      .page { min-height:100%; display:grid; grid-template-rows:auto 1fr; }
      header { padding: 16px 20px; display:flex; align-items:center; gap:12px; }
      header img { width:40px; height:40px; object-fit:contain; }
      header h1 { margin:0; font-size: clamp(1.2rem, 2.8vw, 1.6rem); }
      .actions-right { margin-left:auto; display:flex; gap:10px; }
      .btn { appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block; }
      .btn-primary { background:#2d6cdf; color:#fff; box-shadow:0 8px 18px rgba(45,108,223,.25); }
      .btn-second { background:rgba(236, 236, 238, 0.331); color:#2d6cdf; border: 1px solid rgba(0,0,0,.06) }
      .btn-primary:hover { filter: brightness(0.95); }
      .btn-secondary:hover { background:#e3e9ff; }
      .container { width:min(100%, 1100px); margin:0 auto; padding: 10px 20px 30px; }
      .grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; }
      @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
      @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }
      .card { background: rgba(234, 234, 236, 0.331); border:2px solid rgba(0,0,0,.06); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:14px 16px; }
      .title { font-weight:700; }
      .code { }
      .muted { }

      header h1, .title, .code, .muted { color: #fff; }

      .card {
        background: rgba(53, 56, 71, 0.477);
        border-color: rgba(255,255,255,0.16);
      }
      .btn,
      .btn-primary,
      .btn-secondary { color: #fff; }
      .btn-secondary {
        background: rgba(255,255,255,0.14);
        border: 1px solid rgba(255,255,255,0.22);
      }
      .btn-secondary:hover { background: rgba(255,255,255,0.22); }
      .card h2, .card h3, .card h4, .card h5, .card h6 { color: #fff; }
      .card .title {font-size: 1.5rem}
      .card .code {font-size: 1.2rem}
      .card .muted{
        color: rgba(255,255,255,.78);
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .status-passed {
        background: rgba(74, 222, 128, 0.2);
        color: #4ade80;
        border: 2px solid #4ade80;
      }
      .status-not-passed {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
        border: 2px solid #fbbf24;
      }


      header.container h1{
        color: #000
      }
      
      .actions-right .btn-secondary{
        background: #fff !important;
        color: #2d6cdf !important;         
        border: 1px solid rgba(45,108,223,.35) 
        box-shadow: 0 8px 18px rgba(45,108,223,.12);
      }
      .actions-right .btn-secondary:hover{
        background: #f5f9ff !important;
      }
      .actions-right .btn-secondary:focus{
        outline: 2px solid rgba(45,108,223,.45);
        outline-offset: 2px;
      }
    </style>
  </head>
  <body>
    <div class="bg"></div>
    <div class="page">
      <header class="container">
        <img src="{% static 'img/logos.png' %}" alt="NotMoodle">
        <h1>Browse Lessons</h1>
        <div class="actions-right">
          <a class="btn btn-secondary" href="{% url 'student_management:student_dashboard' %}">Back to Dashboard</a>
          <a class="btn btn-primary" href="{% url 'student_management:student_logout' %}">Log out</a>
        </div>
      </header>
      <main class="container">
        {% if messages %}
          <div style="margin-bottom: 20px;">
            {% for message in messages %}
              <div style="padding: 14px 18px; border-radius: 12px; margin-bottom: 10px; background: {% if message.tags == 'error' %}rgba(239, 68, 68, 0.15){% elif message.tags == 'success' %}rgba(74, 222, 128, 0.15){% else %}rgba(59, 130, 246, 0.15){% endif %}; border: 2px solid {% if message.tags == 'error' %}#ef4444{% elif message.tags == 'success' %}#4ade80{% else %}#3b82f6{% endif %}; color: #fff; font-weight: 600;">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
        {% if lessons %}
          <div class="grid">
            {% for lesson in lessons %}
              <article class="card">
                <div class="title">{{ lesson.title }}</div>
                <div class="code">{{ lesson.unit_code }}</div>
                <p class="muted">{{ lesson.description|default:"No description"|truncatewords:28 }}</p>
                <p class="muted">Credits: {{ lesson.lesson_credits }}</p>
                <p class="muted">Lesson Designer: {{ lesson.lesson_designer.user.get_full_name|default:lesson.lesson_designer }}</p>
                
                {% if lesson_prerequisites %}
                  {% with prereqs=lesson_prerequisites|get_item:lesson.id %}
                    {% if prereqs %}
                      <div style="margin: 12px 0; padding: 10px; background: rgba(255,255,255,0.08); border-radius: 8px; border-left: 3px solid #fbbf24;">
                        <div style="font-weight: 700; margin-bottom: 6px; color: #fbbf24;">
                          Prerequisites:
                        </div>
                        {% for prereq_info in prereqs %}
                          <div style="margin: 4px 0; font-size: 0.9rem;">
                            {% if prereq_info.passed %}
                              <span style="color: #4ade80;">‚úì</span>
                            {% else %}
                              <span style="color: #fbbf24;">‚úó</span>
                            {% endif %}
                            <span class="muted">{{ prereq_info.lesson.title }}</span>
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  {% endwith %}
                {% endif %}
                
                {% if lesson.id in enrolled_ids %}
                  {% if lesson_stats %}
                    {% with lesson_stat=lesson_stats|get_item:lesson.id %}
                      {% if lesson_stat %}
                        {% if lesson_stat.has_grades %}
                          <div style="margin: 12px 0; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; color: #fff;">
                              Overall Mark: {{ lesson_stat.percentage }}%
                            </div>
                            {% if lesson_stat.passed %}
                              <span class="status-badge status-passed">
                                ‚úì PASSED
                              </span>
                              <div style="color: #4ade80; font-weight: 600; font-size: 0.9rem; margin-top: 6px;">
                                Credits Earned: {{ lesson.lesson_credits }}
                              </div>
                            {% else %}
                              <span class="status-badge status-not-passed">
                                ‚úó NOT PASSED
                              </span>
                              <div style="color: #fbbf24; font-weight: 600; font-size: 0.9rem; margin-top: 6px;">
                                Need 50%+ to pass
                              </div>
                            {% endif %}
                          </div>
                        {% elif lesson_stat.total_assignments > 0 %}
                          <div style="margin: 12px 0; padding: 10px; background: rgba(255,255,255,0.08); border-radius: 8px;">
                            <p class="muted" style="font-style: italic; margin: 0;">
                              üìù {{ lesson_stat.total_assignments }} assignment(s) available - No grades yet
                            </p>
                          </div>
                        {% else %}
                          <div style="margin: 12px 0; padding: 10px; background: rgba(255,255,255,0.08); border-radius: 8px;">
                            <p class="muted" style="font-style: italic; margin: 0;">
                              No assignments in this lesson yet
                            </p>
                          </div>
                        {% endif %}
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                  <p><a class="btn btn-secondary" href="{% url 'lessons:detail' lesson.id %}">View Lesson</a></p>
                {% else %}
                  <p><a class="btn btn-primary" href="{% url 'lessons:enroll' lesson.id %}">Enroll</a></p>
                {% endif %}
              </article>
            {% endfor %}
          </div>
        {% else %}
          <p>No lessons available.</p>
        {% endif %}
      </main>
    </div>
  </body>
 </html>
```